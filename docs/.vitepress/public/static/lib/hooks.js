import{cloneDeep as e,get as t,set as n}from"lodash-es";import{computed as s,reactive as o,ref as u,onUnmounted as a,onBeforeUnmount as r,watch as i,nextTick as l,getCurrentInstance as c,watchEffect as p}from"vue";import{useRoute as d,useRouter as f}from"vue-router";import{dayjs as m}from"element-plus";import v from"pubsub-js";import{useWindowScroll as b}from"@vueuse/core";import{useStore as g}from"vuex";const y=Object.prototype.toString;function h(e,t){return y.call(e)===`[object ${t}]`}function S(e){return h(e,"Number")}function w(e){return h(e,"String")}function k(e){return e&&Array.isArray(e)}function C(e){return h(e,"String")&&["[","{"].includes(String(e).substring(0,1))}function O(e,t,n){if(!t)return e;let s=t;k(t)||(s=[t]);let o=n;k(n)||(o=[n]);let u=(S(e)?Number(e):e)??"",a="",r=u,i="";return s.map(((e,t)=>{const n=o[t],s=void 0!==n.fixed?n.fixed:2;switch(e){case"defaultValue":r=w(n.value)&&["[","{"].includes(n.value.substring(0,1))?JSON.parse(n.value):n.value,u=void 0===u||""===u?n.value:u;break;case"substring":u=String(u).substring(n.start||0,n.end||String(u).length);break;case"raise":i=u>=0?"+":"-",u=i+u;break;case"time":u=function(e,t){if(!e)return"";if(t&&t.indexOf("{")>-1){if(!e)return"";if(0===arguments.length)return null;10===(e+"").length&&(e=1e3*+e);const n=t||"{y}-{m}-{d} {h}:{i}:{s}";let s;s="object"==typeof e?e:new Date(parseInt(String(e)));const o={y:s.getFullYear(),m:s.getMonth()+1,d:s.getDate(),h:s.getHours(),i:s.getMinutes(),s:s.getSeconds(),a:s.getDay()};return n.replace(/{(y|m|d|h|i|s|a)+}/g,((e,t)=>{let n=o[t];return"a"===t?["一","二","三","四","五","六","日"][n-1]:(e.length>0&&n<10&&(n="0"+n),n||0)}))}return m(e).format(t||"YYYY-MM-DD")}(u,n.value);break;case"number":if(S(u)){switch(n.value){case"+":u=(u+n.number).toFixed(s);break;case"-":u=(u-n.number).toFixed(s);break;case"*":u=(u*n.number).toFixed(s);break;case"/":u=(u/n.number).toFixed(s)}u*=1}else u="";break;case"dict":u=function(e,t){const{options:n,dictName:s,byKey:o,getKey:u,split:a,returnType:r}=t;if(!String(e)||!s&&!n)return;let i;if(i=n||{}[s],!i||Object.keys(i).length<1)return e;const l=o||"code",c=u||"name",p=a||"、";let d=e;Array.isArray(e)||(d=(e+"").split(p));let f,m="";return"array"===r?(f=[],d.map((e=>{const t=i.find((t=>t[l]+""==e+""));if(!t)return"";f.push(t[c])}))):(m=d.reduce(((e,t,n)=>{const s=i.find((e=>e[l]+""==t+""));return s?e+(n<=d.length-1&&n>0?p+s[c]:s[c]):""}),""),f=m||d.join(p)),f}(u,n);break;case"unit":a=n.value,u+=n.value}})),{value:u,unit:a,defaultValue:r}}const N={base:{title:"",header:{hidden:!0}},layoutConf:{type:"waterfall",base:{colNum:24,maxRows:96,rowHeight:30,isDraggable:!1,isMirrored:!1,isResizable:!1,margin:[10,10],preventCollision:!1,useCssTransforms:!0,verticalCompact:!0},layout:[]},groupConf:{group:[]},asyncConf:{async:[]},pubsubConf:{pubsub:[]}};function M(t){const{store:n}=P(),u=s((()=>n.getters["view/views"]||{})),a=d(),{id:r,projectId:i}=t||{},l=i??n.getters.projectId;let c=r;const p=o({options:e(N),params:{},asyncData:{},reload:async function({id:e}={}){c=e||c,f(),await m()}});if(!c){const e=d(),t=e.meta?.data||{};c=t.sid}function f(){p.params=Object.assign(p?.params||{},a?.query||{})}async function m(){try{const{data:t,success:s}=await function(e){const{request:t,proxy:n}=window.globalProperties.async;return t({url:`${n.node||""}/page-view/query`,type:"POST",params:e||{}})}({menuId:String(c),projectId:l});if(!s)return;const o=t.list&&t.list[0]||{};p.asyncData=o;const{options:u}=x(o,p);p.options=u,n.dispatch("view/setViewCache",{id:c,useful:!0,options:e(u)})}catch(e){console.log(e)}}return f(),u.value[String(c)]?p.options=e(u.value[String(c)].options):m(),p}function x(t,n){const s=C(t.options)?JSON.parse(t.options):t.options||{},o=C(t.layout)?JSON.parse(t.layout):t.layout||[],u=C(t.group)?JSON.parse(t.group):t.group||[],a=C(t.async)?JSON.parse(t.async):t.async||[],r=C(t.pubsub)?JSON.parse(t.pubsub):t.pubsub||[],i=s?.layoutConf?.base||{},l=e(n?.options??N);return Object.assign(l.base,s.base),i&&(i.margin&&i.margin.length>1&&(i.margin[0]=1*i.margin[0],i.margin[1]=1*i.margin[1]),i.colNum=1*i.colNum,i.maxRows=i.maxRows&&1*i.maxRows||void 0,i.isDraggable=!1,i.isResizable=!1,l.layoutConf.type=s?.layoutConf?.type||"grid",Object.assign(l.layoutConf.base,i||{})),l.layoutConf.layout=o,l.groupConf.group=u,l.asyncConf.async=a,l.pubsubConf.pubsub=r,{options:l}}function j(){const e=u(0),t=u(0),n=u(!1);function s(n){e.value=n.pageX,t.value=n.pageY}function o(){n.value=!1,document.removeEventListener("mousemove",s)}return a((()=>o())),{x:e,y:t,moving:n,on:function(){n.value=!0,document.addEventListener("mousemove",s)},off:o}}function F(e){let t,n;const s=()=>t&&v.unsubscribe(t);return new Promise(((o,u)=>{e||u("key is required!"),t=v.subscribe(e,((e,t)=>{"function"==typeof n&&n(t)})),o(),r((()=>s()))})),{subscribe:e=>n=e,unsubscribe:s}}function D(){}function $(){const{y:e}=b();let t;return i(e,(async e=>{await l(),document.documentElement.scrollHeight-1<=window.outerHeight+Number(e)&&t&&t()})),{onBottom:e=>t=e}}function I(e={}){const{app:t}=P(),{router:n,basePath:o,microApps:u}=e,a=s((()=>t.config.globalProperties.$route||{})),r=s((()=>{let e=a.value;const t=o+a.value.path,s=u&&u.find((e=>t.includes(e.activeRule)));if(s){const t=n.getRoutes().find((e=>`${o}${e.path}`===s.activeRule));t&&(e=t)}return e})),i=s((()=>r.value.meta.data)),l=s((()=>JSON.parse(i.value?.options||"{}"))),c=s((()=>void 0===l.value.hiddenHeader?r.value.meta.showHeader:1!==l.value.hiddenHeader)),p=s((()=>void 0===l.value.hiddenHeader?r.value.meta.showSide:1!==l.value.hiddenSide)),d=["/home"],f=s((()=>!d.includes(r.value.path)));return{route:r,menu:i,options:l,showHeader:c,showSide:p,showBreadcrumb:f}}function P(){const{async:e,hooks:t,app:n,router:s}=window.globalProperties||{},o=n?.config?.globalProperties?.$store||g()||{};return o.getters||(o.getters={}),{app:n,store:o,router:s||n?.config?.globalProperties?.$router||f()||{},async:e,hooks:t||{useRoute:d}}}const R=Symbol("SZZT_LOAD_MICRO_APP");function J(e={}){const{microApps:t,appRef:n}=e,{store:o}=P(),{menuPosition:a,menuShowIcon:r}=s((()=>n.value.options?.menu)).value||{},{treeMenus:l}=s((()=>o.getters.menus)).value,c=I(),p=s((()=>c.menu.value?._ids?.[0])),d=s((()=>l?.find((e=>e.id===p.value)))),f=u([]);function m(){let e=[];switch(!0){case"topLeft"===a:e=d.value?.children||[];break;case"left"===a:e=l||[]}f.value=e}m(),i(d,(()=>m()));return F(R).subscribe((e=>{if(t){const n=t[e?.micro.id];if(!n)return;f.value=n.menus?.treeMenus||[]}})),{app:n,headerMenus:l,currentHeaderMenu:d,sideMenus:f,menuPosition:a,menuShowIcon:r}}const T={FieldUIMapper:{e6:"text",e7:"input",e8:"select",e9:"cascader",e10:"checkbox-group",e11:"radio-group",e12:"switch",e13:"date",e14:"rate",e15:"slider",e16:"tag",e17:"image",e18:"colorPicker",e19:"link",e20:"slot",e24:"input-number",e25:"date-picker",e99:"custom"}};function _(e){return`dict_${e}`}function A(n,a){const r=c(),{id:l,menuTypes:d,useArgData:f,menus:m,viewKey:v,labels:b}=n||{},{menus:g}=L({viewKey:v}),y=m||g.value,{jsonMenus:h}=y,{menu:S}=I(),w=h?.[3]||[],C=k(r?.props?.data)?[]:{},O=s((()=>{const e=n?.dataPath,s=r?.props?.data,o=e?t(a?.value,e,""):a?.value,u=(e?t(s,e,""):s)||C;return!0===f||(!u||!Object.keys(u).length)&&!!o?o:u})),N=s((()=>r?.props?.group||{})),M=s((()=>N.value.currentAna||{})),x=s((()=>M.value.fieldConf||{})),j=s((()=>w.find((e=>{const t=String(e.sid);return l?t===String(l):t===String(x.value.parentId)})))),F=s((()=>{let e=[];return e=l?(j.value?.children||[]).map((e=>String(e.sid))):(M.value.fieldConf?.ids||[]).map((e=>String(e))),e})),D=s((()=>x.value.type)),$=o({fields:[],btns:[],modules:[]});function P(){if(!F.value||!F.value.length)return;let t=[];if(!0==("database"===D.value||!!l))t=j.value?.children?.filter((e=>F.value.includes(String(e.sid))))||[];const n=e(b||[]),s=n.map((e=>String(e.sid)));t.map((e=>{s.includes(String(e.sid))||n.push(e)})),t=n;const{fields:o,btns:u,modules:a}=K(t,d);$.fields=o,$.modules=a,$.btns=u}P(),i(F,(()=>P()));const R=s((()=>$)),J=u(R.value.fields||[]),T=u([]),_=u(R.value.btns),A=u(R.value.modules),V=u(),{useFields:Y,useJsonFields:B,useBtns:q,useModules:E,useResultData:U}=H(R,O);return J.value=Y.value,T.value=B.value,_.value=q.value,A.value=E.value,V.value=U.value,p((()=>{const{useFields:e,useJsonFields:t,useBtns:n,useModules:s,useResultData:o}=H(R,O);J.value=e.value,T.value=t.value,_.value=n.value,A.value=s.value,V.value=o.value})),{menu:S,module:j,fieldConf:x,fields:J,jsonFields:T,btns:_,modules:A,transformData:V,asyncData:O}}function H(t,n){const s=u(t.value.fields||[]),o=u([]),a=u(t.value.btns),r=u(t.value.modules),i=u();return function(t,n,s,o){if(k(t.value))if(s.value=[],o.value=[],t.value.length)t.value.map(((t,u)=>{const a={},r={};n.value.map((n=>{n.type||(n.type=T.FieldUIMapper[`e${n.componentType}`]),Y(n,t,a),r[n.key]=e(n)})),s.value.splice(u,0,a),o.value.push(r)}));else{const s={};n.value.map((n=>{n.type||(n.type=T.FieldUIMapper[`e${n.componentType}`]),Y(n,t.value,{}),s[n.key]=e(n)})),o.value.push(s)}else{s.value={},o.value=[];const u={};n.value.map((n=>{n.type||(n.type=T.FieldUIMapper[`e${n.componentType}`]),Y(n,t.value,s.value),u[n.key]=e(n)})),o.value.push(u)}}(n,s,i,o),r.value&&r.value.length&&r.value.map((e=>{if(!e.fields||!e.fields.length)return;const{useFields:t,useJsonFields:s,useBtns:o,useModules:a,useResultData:r}=H(u(e),n);e.fields=t.value,e.transformData=r.value,e.jsonFields=s.value,e.btns=o.value,e.useModules=a.value})),{useFields:s,useBtns:a,useModules:r,useJsonFields:o,useResultData:i}}function K(e,s){const{fields:u,btns:a,modules:r}=function(e,s){const u=o({fields:[],btns:[],modules:[]});return e&&e.length?(u.fields=[],u.btns=[],u.modules=[],e.map((e=>{const o=Number(e.menuType);if(!(s||[3,4,5]).includes(o))return;const a=C(e.options)?JSON.parse(e.options||"{}"):e.options,r=T.FieldUIMapper[`e${e.componentType}`],i=Object.assign({},{label:String(e.name),key:String(e.key),type:r,component:e.component,componentType:e.componentType,children:e.children,icon:e.icon,picture:e.picture,remark:e.remark,path:e.path,link:e.link,_config:e,_options:a});switch(!0){case[5].includes(o):(function(e){return["select","cascader","radio-group","checkbox-group"].includes(e)})(r)&&function(e){const{store:n}=P(),{open:s,props:o}=t(e,"_options.fieldConf",{});if(1!==Number(s)||!o||o.length<1)return;const u=o.find((e=>"options"===e.type));if(!u)return;const a=u.option;let r=[];const i=n.getters.dictData||{},l=String(e.type),c={label:a.label||"label",value:a.value||"value",children:a.children||"children"};switch(a.sourceType){case"chooseType":r=i[_(a.id)]?.tree||[];break;case"node":r=i[_(`n${a.id}`)]?.tree||[],c.label="label",c.value="value";break;case"api":r=i[_(`${a.id}`)]?.list||[]}"cascader"===l?e.props=Object.assign({placeholder:"请选择"},e.props||{},{options:r,props:c}):e.options=r.map((e=>{const t={label:e[c.label],value:e[c.value]};return["radio-group"].includes(l)&&(t.text=t.label,t.label=t.value,t.props||(t.props={}),t.props.border=!0),t}));if(!0===["cascader"].includes(String(e.type)))e.options?.map((e=>e.text=e[c.label]));e.mapper=c}(i),function(e){const{open:s,props:o}=t(e,"_options.fieldConf",{});if(1!==Number(s)||!o||o.length<1)return;const u=o.find((e=>"props"===e.type));if(!u)return;const a=Object.assign(e.props||{},u.option||{});e.props=a,Object.keys(a).map((s=>{let o=t(a,s);const u=h(r=o,"String")&&(String(r).startsWith("function")||String(r).includes("=>"));var r;switch(!0){case"true"===o:o=!0;break;case"false"===o:o=!1;break;case C(o):o=JSON.parse(o);break;case u:o=new Function(`return ${o}`)();break;default:/^(-?\d+)\.?(\d*)$/.test(o)&&(o=parseFloat(o))}const i=`${u?"":"props."}${s}`;delete e.props[s],n(e,i,o)}))}(i),u.fields.push(i);break;case 4===o:!function(e){const{open:n,options:s}=t(e,"_options.btnConf",{});if(1!==Number(n)||!s||s.length<1)return;let o={};const u=s.find((e=>"props"===e.type));u&&(o=u.option||{});e.props=o}(i),u.btns.push(i);break;case 3===o:u.modules.push(i)}})),u):u}(e,s);return[].concat(u||[],a||[]).map((e=>{const t=e.picture;t&&"["===t.substring(0,1)&&(e.picture="",function(e){const{request:t,proxy:n}=window.globalProperties.async;return t({url:`${n.node||""}/file/base64/${e}`,type:"GET"})}(JSON.parse(t)[0].url).then((t=>{e.picture=t})))})),r&&r.length&&r.map((e=>{const t=e.children||[],{fields:n,btns:o,modules:u}=K(t,s);e.fields=n,e.btns=o,e.modules=u})),{fields:u,btns:a,modules:r}}const V=["defaultValue","substring","number","time","dict","raise","unit"];function Y(e,s={},o){const u=t(s,e.key,"");if(e.value=u,n(o,e.key,u),!e._options){const t=C(e.options)?JSON.parse(e.options||"{}"):e.options;e._options=t}const{open:a,transform:r}=t(e,"_options.fieldConf",{});if(1!==Number(a)||!r||r.length<1)return;const i=[],l=[],c=[];V.map((e=>r.findIndex((t=>t.type===e)))).filter((e=>e>-1)).map((e=>c.push(r[e]))),c.map((t=>{const n=t.option||{};if(!0==("dict"===t.type))n.options=e.options,n.byKey="value",n.getKey="label";i.push(t.type),l.push(n)}));const{value:p,unit:d,defaultValue:f}=O(u,i,l);e.value=void 0===u||""===u?f:u,e.tValue=p,e.unit=d,n(o,e.key,p),e.defaultValue=f}function B(e,n){const o=c(),u=s((()=>e||o?.props?.group||{})),{SINGLE_ASYNC:a}=u.value?._base||{};return new Promise(((e,s)=>{const{params:o,paramsCacheClean:r}=n,i=t(u.value,"base.layoutIndex","");v.publish(a,{key:i,params:o||{},paramsCacheClean:r,resolve:e,reject:s})}))}function q(e,n={}){const s=u();return s.value=t(n,e.key,"-"),s.value}function E(e){const{store:t}=P(),n=t.getters.dictData||{},{key:s}=e||{},o=u({}),a=w(s)?[s]:s;return a.length?a.map((e=>{n[e]&&(o.value[e]=n[e])})):o.value=n,{data:o}}function L(e){const{store:t}=P(),{viewKey:n}=e||{},{menus:o,projectId:u}=t.getters||{},a=t.getters["view/viewMenus"]||{},r=n||u;return{menus:s((()=>a[r]||o))}}export{x as createGcOptions,J as useApp,I as useCheckedMenu,E as useDict,M as useGc,P as useGlobal,A as useModule,j as useMouseMove,D as useMutationOberver,$ as useScrollEvent,B as useSingleAsync,L as useState,F as useSubscribe,q as useText};
